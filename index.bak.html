<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片库 - 航通社</title>
    <link rel="stylesheet" href="assets/unified-styles.css">
</head>
<body>
    <!-- 移动端标题栏 -->
    <div class="mobile-header">
        <div class="mobile-header-logo">
            <a href="https://lishuhang.me/" target="_blank" rel="noopener noreferrer">
                <img src="assets/logo.png" alt="航通社" class="logo-image">
            </a>
            <a href="/index.html" class="logo-text">图片库</a>
        </div>
        <button class="hamburger-button" id="hamburgerButton" aria-label="打开菜单">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
    </div>
    
    <!-- 移动端遮罩层 -->
    <div class="sidebar-overlay" id="sidebarOverlay">
        <!-- 关闭按钮 -->
        <button class="close-button" id="closeButton" aria-label="关闭菜单">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <div class="gallery-container">
        <!-- 侧边栏 -->
        <aside class="gallery-sidebar" id="gallerySidebar">
            <div class="gallery-sidebar-header">
                <a href="https://lishuhang.me/" target="_blank" rel="noopener noreferrer">
                    <img src="assets/logo.png" alt="航通社" class="sidebar-logo-image">
                </a>
                <a href="/index.html" class="gallery-sidebar-title">图片库</a>
            </div>
            
            <div class="gallery-sidebar-body">
                <div class="date-selector">
                    <!-- 原图开关 -->
                    <div class="original-image-toggle">
                        <label class="toggle-label">
                            <span class="toggle-text">原图</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="originalImageToggle" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                    </div>
                    
                    <label class="date-selector-label">选择年份和月份</label>
                    
                    <!-- 年份和月份将动态生成 -->
                    <div id="yearMonthContainer">
                        <div class="loading" style="text-align: center; padding: 20px; color: #999;">
                            正在检测数据...
                        </div>
                    </div>
                </div>

                <div class="copyright">
                    © Li Shuhang
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="gallery-main">
            <div id="galleryContent">
                <div class="loading" id="loadingIndicator">
                    正在初始化图库...
                </div>
            </div>
        </main>
    </div>

    <script>
        // 全局变量
        // 注意：这里不再硬编码默认值，将在 initGallery 中根据数据动态设置
        let currentYear = ''; 
        let currentMonth = '';
        let photosData = null;
        let availableMonths = new Set(); // 存储所有可用的年月 (格式: "YYYYMM")

        // 初始化函数
        async function initGallery() {
            console.log('Initializing gallery...');
            
            // 1. 先加载所有可用的月份索引
            await loadAvailableMonths();
            
            // 2. 核心逻辑修改：决定初始显示的年月
            const now = new Date();
            const realCurrentYear = now.getFullYear().toString();
            const realCurrentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            const realCurrentKey = `${realCurrentYear}${realCurrentMonth}`;

            console.log(`Real world date: ${realCurrentYear}-${realCurrentMonth}`);

            if (availableMonths.has(realCurrentKey)) {
                // 情况A：当前现实月份有数据，直接显示
                console.log('Current month has data. Loading current.');
                currentYear = realCurrentYear;
                currentMonth = realCurrentMonth;
            } else {
                // 情况B：当前月没数据，寻找最近的有数据的月份
                console.log('Current month empty. Searching for latest available...');
                
                // 将 Set 转为数组并倒序排列 (大 -> 小)
                const sortedKeys = Array.from(availableMonths).sort((a, b) => b - a);
                
                if (sortedKeys.length > 0) {
                    // 取最大值（即最近的一个月）
                    const latestKey = sortedKeys[0];
                    currentYear = latestKey.substring(0, 4);
                    currentMonth = latestKey.substring(4, 6);
                    console.log(`Fallback to latest available: ${currentYear}-${currentMonth}`);
                } else {
                    // 情况C：完全没有任何数据（极端情况）
                    currentYear = realCurrentYear;
                    currentMonth = realCurrentMonth;
                    console.warn('No data found at all.');
                }
            }

            // 3. UI 渲染
            generateYearMonthSelector();
            bindEvents();
            
            // 4. 加载确定的月份数据
            if (currentYear && currentMonth) {
                loadPhotos(currentYear, currentMonth);
                // 自动展开对应的年份栏
                toggleYear(currentYear);
                // 高亮对应的月份按钮 (因为 generateYearMonthSelector 已经运行，需要手动触发高亮状态)
                setTimeout(() => {
                    updateActiveButtonState(currentYear, currentMonth);
                }, 0);
            }
            
            console.log('Gallery initialized successfully');
        }

        // 加载所有可用的月份数据
        async function loadAvailableMonths() {
            console.log('Loading available months...');
            
            // 定义可能的年份和月份范围
            const startYear = 2007;
            // 修改：结束年份动态获取当前年份，确保跨年可用
            const endYear = new Date().getFullYear(); 
            
            // 遍历所有可能的年月组合，检查文件是否存在
            const checkPromises = [];
            for (let year = startYear; year <= endYear; year++) {
                for (let month = 1; month <= 12; month++) {
                    const yearStr = year.toString();
                    const monthStr = month.toString().padStart(2, '0');
                    const jsonPath = `data/${yearStr}${monthStr}.json`;
                    
                    checkPromises.push(
                        fetch(jsonPath, { method: 'HEAD' })
                            .then(response => {
                                if (response.ok) {
                                    availableMonths.add(`${yearStr}${monthStr}`);
                                }
                            })
                            .catch(() => {
                                // 文件不存在，忽略
                            })
                    );
                }
            }
            
            await Promise.all(checkPromises);
            console.log('Available months loaded:', availableMonths.size, availableMonths);
        }

        // 生成年份和月份选择器
        function generateYearMonthSelector() {
            const container = document.getElementById('yearMonthContainer');
            
            // 从可用月份中提取年份
            const years = new Set();
            availableMonths.forEach(yearMonth => {
                const year = yearMonth.substring(0, 4);
                years.add(year);
            });
            
            // 如果 years 为空（可能是首次使用或无数据），至少显示当前年份
            if (years.size === 0) {
                years.add(new Date().getFullYear().toString());
            }

            // 按年份倒序排列
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            let html = '';
            sortedYears.forEach(year => {
                html += `
                    <div class="year-section">
                        <div class="year-header" data-year="${year}">
                            <span class="year-title">${year}年</span>
                            <svg class="year-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                            </svg>
                        </div>
                        <div class="month-grid" id="months-${year}">
                `;
                
                // 生成12个月份按钮
                for (let month = 1; month <= 12; month++) {
                    const monthStr = month.toString().padStart(2, '0');
                    const yearMonth = `${year}${monthStr}`;
                    const isAvailable = availableMonths.has(yearMonth);
                    // 注意：这里不再生成 active 类，统一在 init 或点击时处理
                    const disabledClass = isAvailable ? '' : ' disabled';
                    
                    if (isAvailable) {
                        html += `<a href="#" class="month-btn${disabledClass}" data-year="${year}" data-month="${monthStr}">${month}</a>`;
                    } else {
                        html += `<span class="month-btn${disabledClass}">${month}</span>`;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function bindEvents() {
            // 年份展开/折叠
            document.querySelectorAll('.year-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const year = e.currentTarget.dataset.year;
                    toggleYear(year);
                });
            });

            // 月份选择
            document.querySelectorAll('.month-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const year = e.target.dataset.year;
                    const month = e.target.dataset.month;
                    console.log('Month clicked:', year, month);
                    selectMonth(year, month);
                });
            });

            // 移动端汉堡按钮切换
            const hamburgerButton = document.getElementById('hamburgerButton');
            if (hamburgerButton) {
                hamburgerButton.addEventListener('click', () => {
                    toggleMobileSidebar();
                });
            }

            // 移动端遮罩层点击关闭
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', (e) => {
                    if (e.target === sidebarOverlay) {
                        closeMobileSidebar();
                    }
                });
            }

            // 移动端关闭按钮点击关闭
            const closeButton = document.getElementById('closeButton');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    closeMobileSidebar();
                });
            }

            // 原图开关切换
            const originalImageToggle = document.getElementById('originalImageToggle');
            if (originalImageToggle) {
                originalImageToggle.addEventListener('change', () => {
                    reloadExpandedPhotos();
                });
            }

            // 日期条目展开/折叠（事件委托）
            document.getElementById('galleryContent').addEventListener('click', (e) => {
                const dateHeader = e.target.closest('.date-header');
                if (dateHeader) {
                    toggleDatePhotos(dateHeader);
                }
            });
        }

        function toggleYear(year) {
            const header = document.querySelector(`[data-year="${year}"]`);
            // 防止 header 不存在报错（例如年份数据为空时）
            if (!header) return; 

            const monthGrid = document.getElementById(`months-${year}`);
            const icon = header.querySelector('.year-icon');

            if (monthGrid.classList.contains('expanded')) {
                // 折叠
                monthGrid.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.classList.add('collapsed');
            } else {
                // 先关闭其他年份
                document.querySelectorAll('.month-grid.expanded').forEach(grid => {
                    grid.classList.remove('expanded');
                });
                document.querySelectorAll('.year-header.expanded').forEach(h => {
                    h.classList.remove('expanded');
                });
                document.querySelectorAll('.year-icon.expanded').forEach(ic => {
                    ic.classList.remove('expanded');
                    ic.classList.add('collapsed');
                });

                // 展开当前年份
                monthGrid.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.remove('collapsed');
                icon.classList.add('expanded');
            }
        }

        // 辅助函数：更新选中状态UI
        function updateActiveButtonState(year, month) {
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetBtn = document.querySelector(`[data-year="${year}"][data-month="${month}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        function selectMonth(year, month) {
            // 更新活动状态
            updateActiveButtonState(year, month);

            // 加载照片
            currentYear = year;
            currentMonth = month;
            loadPhotos(year, month);

            // 移动端自动收起侧边栏
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('gallerySidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerButton');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                hamburger.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                hamburger.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('gallerySidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerButton');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            hamburger.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function loadPhotos(year, month) {
            console.log('Loading photos for:', year, month);
            
            const galleryContent = document.getElementById('galleryContent');
            
            let loadingIndicator = document.getElementById('loadingIndicator');
            if (!loadingIndicator) {
                galleryContent.innerHTML = '<div class="loading" id="loadingIndicator">正在加载照片...</div>';
                loadingIndicator = document.getElementById('loadingIndicator');
            }
            
            loadingIndicator.style.display = 'flex';
            
            try {
                const jsonPath = `data/${year}${month.padStart(2, '0')}.json`;
                const response = await fetch(jsonPath);
                
                if (!response.ok) {
                    throw new Error('No data available');
                }
                
                photosData = await response.json();
                renderPhotos();
            } catch (error) {
                console.error('加载照片数据失败:', error);
                galleryContent.innerHTML = `
                    <div class="empty-state">
                        <p>暂无 ${year}年${month}月 的照片数据</p>
                        <p>请选择其他月份</p>
                    </div>
                `;
            } finally {
                const finalLoadingIndicator = document.getElementById('loadingIndicator');
                if (finalLoadingIndicator) {
                    finalLoadingIndicator.style.display = 'none';
                }
            }
        }

        function renderPhotos() {
            const galleryContent = document.getElementById('galleryContent');
            
            if (!photosData || !photosData.photos) {
                galleryContent.innerHTML = '<div class="empty-state">暂无照片</div>';
                return;
            }

            let html = '';
            const sortedDates = Object.keys(photosData.photos).sort();

            sortedDates.forEach(date => {
                const photos = photosData.photos[date];
                const dateDisplay = `${photosData.month}/${date}`;
                
                html += `
                    <div class="date-item">
                        <div class="date-header" data-date="${date}">
                            <span class="date-title">${dateDisplay}</span>
                            <svg class="date-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                            </svg>
                        </div>
                        <div class="photos-grid" data-date="${date}">
                            <div class="photos-container" id="photos-${date}">
                            </div>
                        </div>
                    </div>
                `;
            });

            galleryContent.innerHTML = html;
        }

        function toggleDatePhotos(dateHeader) {
            const date = dateHeader.dataset.date;
            const photosGrid = document.querySelector(`.photos-grid[data-date="${date}"]`);
            const photosContainer = document.getElementById(`photos-${date}`);
            const icon = dateHeader.querySelector('.date-icon');

            if (photosGrid.classList.contains('expanded')) {
                // 折叠
                photosGrid.classList.remove('expanded');
                dateHeader.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.classList.add('collapsed');
            } else {
                // 展开
                photosGrid.classList.add('expanded');
                dateHeader.classList.add('expanded');
                icon.classList.remove('collapsed');
                icon.classList.add('expanded');

                if (photosContainer.children.length === 0) {
                    loadDatePhotos(date, photosContainer);
                }
            }
        }

        function loadDatePhotos(date, container) {
            if (!photosData || !photosData.photos[date]) {
                container.innerHTML = '<div class="empty-state">这一天没有照片</div>';
                return;
            }

            const photos = photosData.photos[date];
            const baseUrl = photosData.base_url
                .replace('{user_id}', photosData.user_id)
                .replace('{year}', photosData.year)
                .replace('{month}', photosData.month)
                .replace('{day}', date);

            const useOriginal = document.getElementById('originalImageToggle').checked;

            let html = '';
            photos.forEach(filename => {
                const fullUrl = baseUrl + filename;
                const thumbnailUrl = `https://images.weserv.nl/?url=${encodeURIComponent(fullUrl)}&w=300&h=300&output=jpg&q=80&t=square`;
                
                let clickUrl;
                if (useOriginal) {
                    clickUrl = fullUrl;
                } else {
                    clickUrl = `https://images.weserv.nl/?url=${encodeURIComponent(fullUrl)}&output=jpg&q=80`;
                }
                
                html += `
                    <div class="photo-item">
                        <a href="${clickUrl}" target="_blank">
                            <img src="${thumbnailUrl}" alt="照片" loading="lazy">
                        </a>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function reloadExpandedPhotos() {
            const expandedGrids = document.querySelectorAll('.photos-grid.expanded');
            expandedGrids.forEach(grid => {
                const date = grid.dataset.date;
                const photosContainer = document.getElementById(`photos-${date}`);
                if (photosContainer && photosContainer.children.length > 0) {
                    loadDatePhotos(date, photosContainer);
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGallery);
        } else {
            initGallery();
        }
        
        console.log('Gallery script loaded');
    </script>
</body>
</html>