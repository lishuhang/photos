<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片库 - 航通社</title>
    <link rel="stylesheet" href="assets/unified-styles.css">
</head>
<body>
    <!-- 移动端标题栏 -->
    <div class="mobile-header">
        <button class="mobile-date-toggle" id="mobileDateToggle">
            <span>选择年份和月份</span>
            <svg class="mobile-date-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
            </svg>
        </button>
    </div>

    <div class="gallery-container">
        <!-- 侧边栏 -->
        <aside class="gallery-sidebar" id="gallerySidebar">
            <div class="gallery-sidebar-header">
                <a href="/" class="gallery-sidebar-title">航通社</a>
            </div>
            
            <div class="gallery-sidebar-body">
                <div class="date-selector">
                    <label class="date-selector-label">选择年份和月份</label>
                    
                    <!-- 2025年 -->
                    <div class="year-section">
                        <div class="year-header" data-year="2025">
                            <span class="year-title">2025年</span>
                            <svg class="year-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                            </svg>
                        </div>
                        <div class="month-grid" id="months-2025">
                            <a href="#" class="month-btn" data-year="2025" data-month="01">1</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="02">2</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="03">3</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="04">4</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="05">5</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="06">6</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="07">7</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="08">8</a>
                            <a href="#" class="month-btn active" data-year="2025" data-month="09">9</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="10">10</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="11">11</a>
                            <a href="#" class="month-btn" data-year="2025" data-month="12">12</a>
                        </div>
                    </div>

                    <!-- 2024年 -->
                    <div class="year-section">
                        <div class="year-header" data-year="2024">
                            <span class="year-title">2024年</span>
                            <svg class="year-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                            </svg>
                        </div>
                        <div class="month-grid" id="months-2024">
                            <a href="#" class="month-btn" data-year="2024" data-month="01">1</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="02">2</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="03">3</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="04">4</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="05">5</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="06">6</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="07">7</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="08">8</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="09">9</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="10">10</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="11">11</a>
                            <a href="#" class="month-btn" data-year="2024" data-month="12">12</a>
                        </div>
                    </div>

                    <!-- 其他年份可以类似添加 -->
                    <div class="year-section">
                        <div class="year-header" data-year="2023">
                            <span class="year-title">2023年</span>
                            <svg class="year-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                            </svg>
                        </div>
                        <div class="month-grid" id="months-2023">
                            <!-- 月份按钮 -->
                        </div>
                    </div>
                </div>

                <div class="copyright">
                    © Li Shuhang
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="gallery-main">
            <div id="galleryContent">
                <div class="loading" id="loadingIndicator">
                    正在加载照片...
                </div>
            </div>
        </main>
    </div>

    <script>
        class PhotoGallery {
            constructor() {
                this.currentYear = '2025';
                this.currentMonth = '09';
                this.photosData = null;
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadPhotos(this.currentYear, this.currentMonth);
                
                // 默认展开当前年份
                this.toggleYear('2025');
            }

            bindEvents() {
                // 年份展开/折叠
                document.querySelectorAll('.year-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const year = e.currentTarget.dataset.year;
                        this.toggleYear(year);
                    });
                });

                // 月份选择
                document.querySelectorAll('.month-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const year = e.target.dataset.year;
                        const month = e.target.dataset.month;
                        this.selectMonth(year, month);
                    });
                });

                // 移动端日期选择器切换
                const mobileDateToggle = document.getElementById('mobileDateToggle');
                if (mobileDateToggle) {
                    mobileDateToggle.addEventListener('click', () => {
                        this.toggleMobileSidebar();
                    });
                }

                // 日期条目展开/折叠（事件委托）
                document.getElementById('galleryContent').addEventListener('click', (e) => {
                    const dateHeader = e.target.closest('.date-header');
                    if (dateHeader) {
                        this.toggleDatePhotos(dateHeader);
                    }
                });
            }

            toggleYear(year) {
                const header = document.querySelector(`[data-year="${year}"]`);
                const monthGrid = document.getElementById(`months-${year}`);
                const icon = header.querySelector('.year-icon');

                if (monthGrid.classList.contains('expanded')) {
                    monthGrid.classList.remove('expanded');
                    icon.classList.remove('expanded');
                    icon.classList.add('collapsed');
                } else {
                    // 先关闭其他年份
                    document.querySelectorAll('.month-grid.expanded').forEach(grid => {
                        grid.classList.remove('expanded');
                    });
                    document.querySelectorAll('.year-icon.expanded').forEach(ic => {
                        ic.classList.remove('expanded');
                        ic.classList.add('collapsed');
                    });

                    // 展开当前年份
                    monthGrid.classList.add('expanded');
                    icon.classList.remove('collapsed');
                    icon.classList.add('expanded');
                }
            }

            selectMonth(year, month) {
                // 更新活动状态
                document.querySelectorAll('.month-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-year="${year}"][data-month="${month}"]`).classList.add('active');

                // 加载照片
                this.currentYear = year;
                this.currentMonth = month;
                this.loadPhotos(year, month);

                // 移动端自动收起侧边栏
                if (window.innerWidth <= 768) {
                    this.closeMobileSidebar();
                }
            }

            toggleMobileSidebar() {
                const sidebar = document.getElementById('gallerySidebar');
                const icon = document.querySelector('.mobile-date-icon');
                
                if (sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                    icon.classList.remove('expanded');
                    icon.classList.add('collapsed');
                } else {
                    sidebar.classList.add('mobile-open');
                    icon.classList.remove('collapsed');
                    icon.classList.add('expanded');
                }
            }

            closeMobileSidebar() {
                const sidebar = document.getElementById('gallerySidebar');
                const icon = document.querySelector('.mobile-date-icon');
                
                sidebar.classList.remove('mobile-open');
                icon.classList.remove('expanded');
                icon.classList.add('collapsed');
            }

            async loadPhotos(year, month) {
                const loadingIndicator = document.getElementById('loadingIndicator');
                const galleryContent = document.getElementById('galleryContent');
                
                loadingIndicator.style.display = 'flex';
                
                try {
                    const response = await fetch(`${year}/${month.padStart(2, '0')}/data.json`);
                    
                    if (!response.ok) {
                        // 如果当前月份没有数据，尝试加载上个月
                        const prevMonth = this.getPreviousMonth(year, month);
                        if (prevMonth) {
                            this.selectMonth(prevMonth.year, prevMonth.month);
                            return;
                        }
                        throw new Error('No data available');
                    }
                    
                    this.photosData = await response.json();
                    this.renderPhotos();
                } catch (error) {
                    console.error('加载照片数据失败:', error);
                    galleryContent.innerHTML = '<div class="empty-state">暂无照片数据</div>';
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }

            getPreviousMonth(year, month) {
                const y = parseInt(year);
                const m = parseInt(month);
                
                if (m > 1) {
                    return { year: y.toString(), month: (m - 1).toString().padStart(2, '0') };
                } else if (y > 2018) {
                    return { year: (y - 1).toString(), month: '12' };
                }
                
                return null;
            }

            renderPhotos() {
                const galleryContent = document.getElementById('galleryContent');
                
                if (!this.photosData || !this.photosData.photos) {
                    galleryContent.innerHTML = '<div class="empty-state">暂无照片</div>';
                    return;
                }

                let html = '';
                const sortedDates = Object.keys(this.photosData.photos).sort();

                sortedDates.forEach(date => {
                    const photos = this.photosData.photos[date];
                    const dateDisplay = `${this.photosData.month}/${date}`;
                    
                    html += `
                        <div class="date-item">
                            <div class="date-header" data-date="${date}">
                                <span class="date-title">${dateDisplay}</span>
                                <svg class="date-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                                    <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
                                </svg>
                            </div>
                            <div class="photos-grid" data-date="${date}">
                                <div class="photos-container" id="photos-${date}">
                                    <!-- 照片将在点击时动态加载 -->
                                </div>
                            </div>
                        </div>
                    `;
                });

                galleryContent.innerHTML = html;
            }

            toggleDatePhotos(dateHeader) {
                const date = dateHeader.dataset.date;
                const photosGrid = document.querySelector(`.photos-grid[data-date="${date}"]`);
                const photosContainer = document.getElementById(`photos-${date}`);
                const icon = dateHeader.querySelector('.date-icon');

                if (photosGrid.classList.contains('expanded')) {
                    // 折叠
                    photosGrid.classList.remove('expanded');
                    dateHeader.classList.remove('expanded');
                    icon.classList.remove('expanded');
                    icon.classList.add('collapsed');
                } else {
                    // 展开并加载照片
                    photosGrid.classList.add('expanded');
                    dateHeader.classList.add('expanded');
                    icon.classList.remove('collapsed');
                    icon.classList.add('expanded');

                    // 如果照片容器为空，则加载照片
                    if (photosContainer.children.length === 0) {
                        this.loadDatePhotos(date, photosContainer);
                    }
                }
            }

            loadDatePhotos(date, container) {
                if (!this.photosData || !this.photosData.photos[date]) {
                    container.innerHTML = '<div class="empty-state">这一天没有照片</div>';
                    return;
                }

                const photos = this.photosData.photos[date];
                const baseUrl = this.photosData.base_url
                    .replace('{user_id}', this.photosData.user_id)
                    .replace('{year}', this.photosData.year)
                    .replace('{month}', this.photosData.month)
                    .replace('{day}', date);

                let html = '';
                photos.forEach(filename => {
                    const fullUrl = baseUrl + filename;
                    const thumbnailUrl = `https://images.weserv.nl/?url=${encodeURIComponent(fullUrl)}&w=300&h=300&output=jpg&q=80&t=square`;
                    
                    html += `
                        <div class="photo-item">
                            <a href="${fullUrl}" target="_blank">
                                <img src="${thumbnailUrl}" alt="照片" loading="lazy">
                            </a>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }
        }

        // 初始化图片库
        document.addEventListener('DOMContentLoaded', () => {
            new PhotoGallery();
        });
    </script>
</body>
</html>
